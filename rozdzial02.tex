\chapter{Przygotowania \emph{Know-how}}
\label{chap:know-how}
\section{Projektowanie REST API}
\label{sec:projektowanie-api}
Projektowanie i tworzenie \texttt{API} (ang.~\emph{Application Programming Interface}) współcześnie jest jednym z podstawowych zadań programisty. Zadaniem API jest udostępnienie i ochrona swoich zasobów. Zasoby te to najczęściej dane i w zależności od uprawnień klient może je zmieniać, lub tylko pobierać. Klientem może być strona internetowa służąca do wyświetlania i zarządzania danymi, a także inna aplikacja serwerowa korzystająca z tych danych.

Użycie API do dostarczania danych do aplikacji klienckiej pozwala rozdzielić logikę widoku po stronie klienta oraz logikę biznesową po stronie serwera. Zaletą tego rozwiązania jest uproszczenie implementacji i w perspektywie ułatwienia utrzymywania tworzonego programu. Ponadto tak tworzone oprogramowanie jest bardziej elastyczne i łatwiej można je integrować z~innymi systemami. Stworzenie takiego API nie jest zadaniem łatwym. Dlatego w sekcji~\ref{subsec:api-dobre-praktyki} przedstawione zostaną dobre praktyki.

Często trzeba szybko stworzyć nowe API lub zmodyfikować już istniejące. Dodawanie funkcji filtrowania, sortowania czy łączenia danych z~różnych zasobów jest czasochłonne i~nudne. Implementacja takich funkcjonalności zmusza nas do dodawania nowych punktów dostępu (ang.~\emph{endpoint}) do już istniejących zasobów lub modyfikowania tych już istniejących. Problemem jest także budowanie adresu \texttt{URL} (ang.~\emph{Uniform Resource Locator}). Musi być on elastyczny i intuicyjny, aby można było pracować bez ciągłego wertowania dokumentacji. Z pomocą tutaj przychodzi zapoczątkowany przez Microsoft i zatwierdzony przez \texttt{ISO} (ang.~\emph{International Organization for Standardization}) protokół \texttt{OData} (ang.~\emph{Open Data Protocol}) i jego gotowe implementacje. Zostanie on opisany w sekcji~\ref{subsec:odata}

\subsection{Dobre praktyki tworzenia API} 
\label{subsec:api-dobre-praktyki}
Aby stworzyć czytelne i elastyczne REST API należy zastosować się do wielu zasad. Oczywiście nie są one obowiązkowe. Najczęściej jednak stosowanie się do nich ułatwia konsumowanie API i integrowanie go z innymi systemami. Jednym z koniecznych do szybkiej i bezproblemowej pracy z API kroków jest stworzenie i późniejsze aktualizowanie jego dokumentacji. Polecanym i nowoczesnym narzędziem służący do jej tworzenia jest \texttt{Swagger}. 

API projektujemy dla zasobów, które są rzeczownikami. Dlatego adres URL, a dokładniej jego ścieżka zasobów (ang.~\emph{resource path}) powinna być złożona z rzeczowników. Zalecane jest, aby używać liczby mnogiej rzeczownika, gdyż zazwyczaj zasób to zbiór przykładowo kont bankowych. Natomiast, aby wyrazić akcję, którą wykonuje się na zasobie należy użyć odpowiedniej metody \texttt{HTTP} (ang.~\emph{HTTP Verb}). W tabeli~\ref{tab:http-verb} widać wzorzec zastosowania metod HTTP~\cite{api-good-practises-1}.

\begin{table}
    \centering
    \caption{Użycie metod HTTP}
    \label{tab:http-verb}
    \begin{tcolorbox}[tab2,tabularx={X||Y|Y|Y|Y}]
    \texttt{Zasób}      & \texttt{GET}     & \texttt{POST}    & \texttt{PUT}      & \texttt{DELETE}   \\\hline\hline
    /bank-account   & Zwraca listę kont & Tworzy nowe konto &  Zbiorczo aktualizuje konta &  Usuwa wszystkie konta \\\hline
    {\small /bank-account/1} & Zwraca określone konto & Metoda niedozwolona (405) &  Aktualizuje określone konto &  Usuwa określone konto \\\hline
    \end{tcolorbox}
\end{table} 

Kolejną ważną praktyką przy tworzeniu API jest zwracanie odpowiedniego kodu odpowiedzi HTTP (ang.~\emph{HTTP Status Code}), aby poinformować klienta o sposobie realizacji jego żądania. Żądanie może zakończone być sukcesem bądź niepowodzeniem. Jednak konieczne jest używanie więcej niż dwóch kodów odpowiedzi, aby dokładnie określić, co ten sukces lub niepowodzenie oznaczają. Dokument \texttt{RFC7231} opisuje, kiedy i jak używać konkretnych kodów odpowiedzi HTTP. Statusy HTTP dzielimy na pięć klas, które rozróżniane są po pierwszej cyfrze kodu odpowiedzi HTTP~\cite{rfc7231}.

\begin{itemize}
\item \texttt{1XX} -- Informacja -- Żądanie zostało odebrane, proces jest kontynuowany.  
\item \texttt{2XX} -- Sukces -- Żądanie zostało pomyślnie odebrane, zrozumiane i zaakceptowane. 
\item \texttt{3XX} -- Przekierowanie -- Konieczne jest podjęcie dalszych działań w celu zakończenia żądania.
\item \texttt{4XX} -- Błąd klienta -- Żądanie zawiera złą składnię lub nie może być zrealizowane.
\item \texttt{5XX} -- Błąd serwera -- Serwerowi nie udało zrealizować się poprawnego żądania.
\end{itemize}

W tabeli~\ref{tab:http-status} przedstawiono najczęściej używane w REST API statusy HTTP i ich znaczenie~\cite{api-good-practises-2, rfc7231}.  
Warto wspomnieć, że statusu \texttt{204} używa się najczęściej, gdy serwer nie zwraca w~ciele odpowiedzi żadnych danych. Sytuacją taką jest między innymi usuwanie zasobu.

\begin{table}
    \centering
    \caption{Kody odpowiedzi HTTP}
    \label{tab:http-status}
    \begin{tcolorbox}[tab2,tabularx={p{.30\linewidth}|Y}]
    \texttt{Kod HTTP}    & \texttt{Opis}   \\\hline\hline
    \texttt{200: OK}
        & Żądanie zakończone sukcesem. \\\hline
    \texttt{201: Created}
        & Stworzony został nowy zasób. \\\hline
    \texttt{204: No Content}
        & W ciele odpowiedzi nie ma żadnej dodatkowej treści.\\\hline
    \texttt{400: Bad Request}
        & Serwer nie może przetworzyć żądania z powodu błędu klienta.   \\\hline
    \texttt{401: Unauthorized}
        & Żądanie nie zostało przetworzone, ponieważ brakuje poprawnych danych uwierzytelniających dla docelowego zasobu. \\\hline
    \texttt{403: Forbidden}
        & Podane dane uwierzytelniające nie są wystarczające do autoryzacji żądania. \\\hline
    \texttt{404: Not Found}
        & Serwer źródłowy nie znalazł bieżącej reprezentacji zasobu docelowego lub nie chce ujawnić, że istnieje. \\\hline
    \texttt{500: Internal Server Error}
        & Serwer napotkał nieoczekiwany warunek, który uniemożliwił mu spełnienie żądania. \\\hline
    \end{tcolorbox}
\end{table}

Ważną zasadą dotyczącą API jest to, aby po stworzeniu nowego zasobu zwróciła jego reprezentację, na przykład w postaci \texttt{JSON} (ang.~\emph{JavaScript Object Notation}). Dotyczy to w szczególności metody \texttt{POST}. W przypadku powodzenia serwer powinien zwrócić w takim wypadku odpowiedź z kodem \texttt{201}, a także dodatkowy nagłówek z lokalizacją nowostworzonego zasobu (ang.~\emph{Location Header}). Dodatkowo rekomendowane jest, aby dane stworzonego obiektu lub obiektów zapakować w pole danych (ang.~\emph{data} co~pokazano na listingu~\ref{list:response200}. 

{\belowcaptionskip=-10pt
\begin{lstlisting}[label=list:response200,
    caption=Przykład pomyślnej odpowiedzi serwera]
//200 OK
{
  "errors": [],
  "data": {
    "firstName": "Paweł",
    "lastName": "Żółaniecki",
    "age": 24
  },
}
\end{lstlisting}
}

Umieszczanie lokalizacji dostępnych zasobów wpisuję się w realizację koncepcji \texttt{HATEOAS} (ang.~\emph{Hypermedia As Transfer Engine Of Application State}). Pełna realizacja tej koncepcji zapewnia łatwą nawigację pomiędzy powiązanymi zasobami i przedstawia dostępne akcje na danym zasobie, poprzez umieszczanie w metadanych odpowiedzi linków URL do konkretnych akcji i zasobów.

W zależności od strategii biznesowej przyjętej w projekcie, gdy klient nie ma uprawnień do~zasobu, można zwrócić nie tylko kod \texttt{403}, ale także \texttt{404}, gdy serwer chce ukryć istnienie zasobu.

Dobrym zwyczajem jest umieszczanie w odpowiedzi z kodem \texttt{400} i \texttt{403} dokładniejszej informacji o przyczynie braku realizacji żądania. W podobny sposób powinno się informować klienta także o błędach. Częstą praktyką jest zwracanie w ciele odpowiedzi tabeli z listą błędów~\ref{list:response400}

{\belowcaptionskip=-10pt
\begin{lstlisting}[label=list:response400,
    caption=Odpowiedź serwera zawierająca opis błędu]
//400 Bad Request
{
  "errors": [
    {
      "status": 400,
      "details": "Invalid state. Valid state are 'draft', 'success' or 'failure'"
    }
  ]
}
\end{lstlisting}
}

Istotnym także jest, żeby nie tworzyć nowych adresów \texttt{URL} dla filtrowanego czy sortowanego zasobu. Lepszym podejściem jest przedstawić wyżej wymienione kryteria w ścieżce wyszukiwania adresu \texttt{URL} (ang.~\emph{query string}). W sekcji~\ref{subsec:odata} przedstawiony zostanie wybrany przez autora elastyczny protokół, określający strategię wyszukiwania i filtrowania zasobów za pomocą określonych parametrów ścieżki wyszukiwania adresu URL.

\subsection{Protokół OData}
\label{subsec:odata}



\section{Użyte wzorce projektowe}
\label{sec:wzorce}

\subsection{Mediator}
\label{subsec:mediator}

\subsection{Podział odpowiedzialności czyli CQRS}
\label{subsec:cqrs}

\begin{table}[htb]
\centering\small
\caption{Pliki źródłowe szablonu oraz wyniki kompilacji}
\label{tab:szablon}
\begin{tabularx}{\linewidth}{|p{.55\linewidth}|X|}\hline
Źródła & Wyniki kompilacji \\ \hline\hline
\verb?Dokument.tex? - dokument główny\newline
\verb?Dokument.tcp? -- szablon projektu \texttt{MiKTeX}\newline
\verb?rozdzial01.tex? -- plik rozdziału \texttt{01}\newline
\verb?...?\newline
\verb?dodatekA.tex? -- plik dodatku \texttt{A}\newline
\verb?...?\newline
\verb?rys01? -- katalog na rysunki do rozdziału \texttt{01}\newline
\verb?   |- fig01.png? -- plik grafiki\newline
\verb?   |- ...?\newline
\verb?...?\newline
\verb?rysA? -- katalog na rysunki do dodatku \texttt{A}\newline
\verb?   |- fig01.png? -- plik grafiki\newline
\verb?   |- ...?\newline
\verb?...?\newline
\verb?dokumentacja.bib? -- plik danych bibliograficznych\newline
\verb?Dyplom.ist? -- plik ze stylem indeksu\newline
\verb?by-nc-sa.png? -- plik z ikonami CC\newline
 &
\verb?Dyplom.bbl?\newline
\verb?Dyplom.blg?\newline
\verb?Dyplom.ind?\newline
\verb?Dyplom.idx?\newline
\verb?Dyplom.lof?\newline
\verb?Dyplom.log?\newline
\verb?Dyplom.lot?\newline
\verb?Dyplom.out?\newline
\verb?Dyplom.pdf? -- dokument wynikowy\newline
\verb?Dyplom.syntex?\newline
\verb?Dyplom.toc?\newline
\verb?Dyplom.tps?\newline
\verb?*.aux?\newline 
\verb?Dyplom.synctex?\newline\\
\hline
\end{tabularx}
\end{table}


\begin{lstlisting}[basicstyle=\ttfamily]
> pdflatex Dyplom.tex
\end{lstlisting}

\begin{lstlisting}[basicstyle=\ttfamily]
> bibtex Dyplom
\end{lstlisting}
Szczegóły dotyczące przygotowania danych bibliograficznych oraz zastosowania cytowań przedstawiono w podrozdziale \ref{sec:literatura}.

W głównym pliku zamieszczono polecenia pozwalające sterować procesem kompilacji poprzez włączanie bądź wyłączanie kodu źródłowego poszczególnych rozdziałów. Włączanie kodu do kompilacji zapewniają instrukcje \verb+\include+ oraz \verb+\includeonly+. Pierwsza z nich pozwala włączyć do kompilacji kod wskazanego pliku (np.\ kodu źródłowego pierwszego rozdziału \verb+\include{rozdzial01.tex}+). Druga, jeśli zostanie zastosowana, pozwala określić, które z~plików zostaną skompilowane w całości (na przykład kod źródłowy pierwszego i drugiego rozdziału \verb+\includeonly{rozdzial01.tex,rozdzial02.tex}+).
Brak nazwy pliku na liście w poleceniu \verb+\includeonly+ przy jednoczesnym wystąpieniu jego nazwy w poleceniu \verb+\include+ oznacza, że w kompilacji zostaną uwzględnione referencje wygenerowane dla tego pliku wcześniej, sam zaś kod źródłowy pliku nie będzie kompilowany. 

W szablonie wykorzystano klasę dokumentu \texttt{memoir} oraz wybrane pakiety. Podczas kompilacji szablonu w \texttt{MikTeXu} wszelkie potrzebne pakiety zostaną zainstalowane automatycznie (jeśli \texttt{MikTeX} zainstalowano z opcją dynamicznej instalacji brakujących pakietów). W przypadku innych dystrybucji latexowych może okazać się, że pakiety te trzeba doinstalować ręcznie (np.\ pod linuxem z \texttt{TeXLive} trzeba doinstalować dodatkową zbiorczą paczkę, a jeśli ma się menadżera pakietów latexowych - to pakiety latexowe można instalować indywidualnie).

Jeśli w szablonie będzie wykorzystany indeks rzeczowy, kompilację źródeł trzeba będzie rozszerzyć o kroki potrzebne na wygenerowanie plików pośrednich \texttt{Dokument.idx} oraz \texttt{Dokument.ind} oraz dołączenia ich do finalnego dokumentu (podobnie jak to ma miejsce przy generowaniu wykazu literatury).
Szczegóły dotyczące generowania indeksu rzeczowego opisano w podrozdziale~\ref{sec:indeks}.

\section{Autoryzacja OpenId Connect}
\label{sec:autoryzacja}